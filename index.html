<!DOCTYPE HTML>
<html>
<head>
    <!-- when using the mode "code", it's important to specify charset utf-8 -->
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">

    <link href="assets/css/main.css" rel="stylesheet" type="text/css"/>

    <link href="node_modules/jsoneditor/dist/jsoneditor.min.css" rel="stylesheet" type="text/css"/>
    <script src="node_modules/jsoneditor/dist/jsoneditor.min.js"></script>

    <script src="https://bgrins.github.io/filereader.js/filereader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2014-11-29/FileSaver.min.js"></script>

</head>
<body>
    <div id="contentpane">
        <div>
            Upload template: <input type="file" id="loadDocument" value="Load"/>
        </div>
        <div id="jsoneditor"></div>
        <div>
            <input type="button" id="saveDocument" value="Download JSON" />
        </div>
    </div>

    <script>
        // create the editor
        const container = document.getElementById("jsoneditor")
        const options = {
            mode: 'tree',
            modes: ['code', 'form', 'text', 'tree', 'view', 'preview'], // allowed modes
            onError: function (err) {
                alert(err.toString())
            }
        }

        const editor = new JSONEditor(container, options)
        editor.expandAll();

        // set json
        const initialJSON = "assets/js/em_metadata.json";
        fetch(initialJSON)
            .then(response => response.json())
            .then(data => {
                editor.set(data);
                editor.expandAll();
            });


        // Load a JSON document
        FileReaderJS.setupInput(document.getElementById('loadDocument'), {
            readAsDefault: 'Text',
            on: {
                load: function (event, file) {
                    editor.setText(event.target.result)
                }
            }
        })

        // Save a JSON document
        document.getElementById('saveDocument').onclick = function () {
            // Save Dialog
            let fname = window.prompt("Save as...","metadata.json")

            // Check json extension in file name
            if (fname.indexOf(".") === -1) {
                fname = fname + ".json"
            } else {
                if (fname.split('.').pop().toLowerCase() === "json") {
                    // Nothing to do
                } else {
                    fname = fname.split('.')[0] + ".json"
                }
            }
            const blob = new Blob([editor.getText()], { type: 'application/json;charset=utf-8' })
            saveAs(blob, fname)
        }
    </script>
</body>

</html>